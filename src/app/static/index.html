<!DOCTYPE html>
<html>
<head>
    <title>Dispatcher Simulation</title>
    <style>
        body { background: #111; color: white; text-align: center; font-family: Arial; }
        .road { stroke: #888; stroke-width: 3; }
        .node { fill: #ccc; }
        .unit { stroke: white; stroke-width: 1; }
    </style>
</head>
<body>

<h2>Emergency Dispatcher Simulation</h2>

<svg id="map" width="700" height="700"
     viewBox="-50 -50 550 550"
     style="background:#1e1e1e; border:1px solid #555;">
</svg>

<div id="info" style="margin-top:20px;"></div>


<script>
let graphData = null;

async function loadGraph() {
    const graphRes = await fetch("/graph");
    graphData = await graphRes.json();

    const svg = document.getElementById("map");
    svg.innerHTML = "";

    // Draw roads
    graphData.edges.forEach(e => {
        const n1 = graphData.nodes.find(n => n.id === e.from);
        const n2 = graphData.nodes.find(n => n.id === e.to);

        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        line.setAttribute("x1", n1.x);
        line.setAttribute("y1", n1.y);
        line.setAttribute("x2", n2.x);
        line.setAttribute("y2", n2.y);
        line.setAttribute("class", "road");
        svg.appendChild(line);
    });

    // Draw nodes
    graphData.nodes.forEach(n => {
        const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        circle.setAttribute("cx", n.x);
        circle.setAttribute("cy", n.y);
        circle.setAttribute("r", 8);
        circle.setAttribute("class", "node");
        circle.style.cursor = "pointer";

        circle.addEventListener("click", () => {
            createIncident(n.id);
        });

        svg.appendChild(circle);
    });

    createUnitCircles();
}

async function createUnitCircles() {
    const res = await fetch("/state");
    const data = await res.json();

    const svg = document.getElementById("map");

    data.units.forEach(u => {
        const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        circle.setAttribute("id", u.id);
        circle.setAttribute("r", 10);
        circle.setAttribute("class", "unit");

        if (u.service === "fire") circle.setAttribute("fill", "red");
        if (u.service === "medical") circle.setAttribute("fill", "lime");
        if (u.service === "police") circle.setAttribute("fill", "cyan");

        svg.appendChild(circle);
    });
}

async function update() {
    const res = await fetch("/state");
    const data = await res.json();

    data.units.forEach(u => {
        const el = document.getElementById(u.id);
        if (el) {
            el.setAttribute("cx", u.x);
            el.setAttribute("cy", u.y);
        }
    });
}

async function createIncident(nodeId) {

    const type = prompt("Type: fire / medical / accident");
    const severity = parseInt(prompt("Severity (1-5):"));

    if (!type || !severity) return;

    const res = await fetch(`/create_incident`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            node: nodeId,
            type: type,
            severity: severity
        })
    });

    const data = await res.json();

    document.getElementById("info").innerText =
        `Assigned: ${data.assigned}\n${data.explanation}`;
}

loadGraph();
setInterval(update, 100);
</script>

</body>
</html>